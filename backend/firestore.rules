rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function roleOrder(role) {
      return role == 'admin' ? 3 : role == 'master' ? 2 : role == 'manager' ? 1 : 0;
    }

    function currentRole() {
      return request.auth != null && request.auth.token.role != null
        ? request.auth.token.role
        : 'student';
    }

    function hasRole(requiredRole) {
      return request.auth != null && roleOrder(currentRole()) >= roleOrder(requiredRole);
    }

    function clubDocument(clubId) {
      return get(/databases/$(database)/documents/clubs/$(clubId));
    }

    function clubData(clubId) {
      return clubDocument(clubId).data;
    }

    function isClubManager(clubId) {
      return hasRole('admin')
        || (
          request.auth != null
          && clubData(clubId) != null
          && clubData(clubId).managerIds != null
          && clubData(clubId).managerIds.hasAny([request.auth.uid])
        );
    }

    function isClubMaster(clubId) {
      return hasRole('admin')
        || (
          request.auth != null
          && clubData(clubId) != null
          && clubData(clubId).masterId != null
          && clubData(clubId).masterId == request.auth.uid
        );
    }

    match /users/{userId} {
      allow read: if request.auth != null && (request.auth.uid == userId || hasRole('admin'));
      allow write: if hasRole('admin');
    }

    match /clubs/{clubId} {
      allow read: if request.auth != null;
      allow create, update, delete: if hasRole('admin');

      match /events/{eventId} {
        allow read: if request.auth != null;
        allow create, update, delete: if isClubManager(clubId) || isClubMaster(clubId);

        match /attendance/{attendanceId} {
          allow read: if request.auth != null;
          allow create: if request.auth != null && (
            request.auth.uid == attendanceId
            || isClubManager(clubId)
            || isClubMaster(clubId)
          );
          allow update, delete: if isClubManager(clubId) || isClubMaster(clubId);
        }
      }

      match /certificates/{certificateId} {
        allow read: if request.auth != null;
        allow create, update, delete: if isClubMaster(clubId);
      }

      match /resources/{resourceId} {
        allow read: if request.auth != null;
        allow write: if isClubManager(clubId) || isClubMaster(clubId);
      }
    }

    match /logs/{logId} {
      allow read: if hasRole('manager');
      allow write: if hasRole('manager');
    }

    match /{document=**} {
      allow read: if request.auth != null;
      allow write: if hasRole('admin');
    }
  }
}
